---
title: "Trabalho de Extra√ß√£o"
subtitle: "Brain Lower Glioma"
author: "C√°tia Ros√°rio (pg57791) + Vanessa Rodriguez (pg49131) + Andr√© Dias (pg55127)"
date: "2025-03-21"
output: 
  prettydoc::html_pretty:
    theme: cayman
    toc: yes
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

**Workflow:**

1.  Explica√ß√£o de origem e relev√¢ncia dos dados

2.  Prepara√ß√£o e pr√©-processamento dos dados

3.  Sumariza√ß√£o dos dados e gr√°ficos

4.  An√°lise estat√≠stica univariada

5.  An√°lise de express√£o diferencial e enriquecimento

\

## **1. Explica√ß√£o de origem e relev√¢ncia dos dados**

### Origem dos dados  
Os dados prov√™m do estudo *"LGG TCGA PanCancer Atlas 2018"*, dispon√≠vel no portal cBioPortal: [üîó cBioPortal](https://www.cbioportal.org/study/summary?id=lgg_tcga_pan_can_atlas_2018).  

Esse estudo faz parte do The Cancer Genome Atlas (TCGA), um grande projeto colaborativo que visa caracterizar geneticamente diversos tipos de cancro usando tecnologias de alto rendimento, como RNA-Seq para express√£o gen√©tica.  

---

### Tipo de cancro estudado  
Este dataset est√° focado no *Glioma de baixo grau* (Low Grade Glioma - LGG), um tipo de tumor cerebral com evolu√ß√£o mais lenta do que o glioblastoma, mas que pode ser fatal em v√°rios casos. 

Apesar da sua progress√£o mais lenta, o *LGG apresenta uma elevada heterogeneidade molecular*, tornando-se relevante para estudos de estratifica√ß√£o de pacientes e identifica√ß√£o de subtipos tumorais.  

---

### Dados dispon√≠veis  
No *cBioPortal*, este estudo inclui:  
- *Dados cl√≠nicos* (idade, sexo, sobrevida, etc.)  
- *Dados de Express√£o G√©nica* (RNA-Seq)  
- *Dados de Muta√ß√£o Som√°tica*  
- *Dados de CNV* (altera√ß√µes no n√∫mero de c√≥pias)  
- *Dados de Metila√ß√£o*  
- *Dados de Fus√µes*  

Todos esses dados s√£o *integr√°veis, permitindo an√°lises multi-√≥micas para uma vis√£o mais ampla dos mecanismos moleculares envolvidos no desenvolvimento e progress√£o do **glioma*.  
  

---

### Dados de Express√£o G√©nica (*RNA-Seq*)  
Os dados de express√£o g√©nica foram processados usando o m√©todo *RSEM, com **normaliza√ß√£o por lote* (batch-normalized) a partir da plataforma *Illumina HiSeq RNASeqV2*.  

A matriz de express√£o cont√©m *milhares de genes* (geralmente cerca de 20.000), permitindo an√°lises em larga escala de:  
- *Express√£o diferencial*  
- *Coexpress√£o*  
- *Redes regulat√≥rias*  
 

---

### Relev√¢ncia cient√≠fica  
Este tipo de dados permite identificar *genes diferencialmente expressos* entre:  
- *Subtipos tumorais*  
- *Grupos com ou sem muta√ß√µes espec√≠ficas*  
- *Amostras normais e tumorais*  

No caso do estudo, est√£o dispon√≠veis apenas as *514 amostras tumorais* de *glioma de baixo grau (LGG)*.  

Essas an√°lises podem contribuir para:  
- *Descoberta de biomarcadores moleculares*  
- *Estratifica√ß√£o de pacientes com base em perfis de express√£o*  
- *Identifica√ß√£o de poss√≠veis alvos terap√™uticos*  

Al√©m disso, os dados podem ser utilizados em *an√°lises de enriquecimento funcional* (como GSEA ou over-representation analysis) para responder a perguntas como:  

> Quais as vias biol√≥gicas que est√£o mais ativas ou reprimidas em determinados grupos de pacientes?  

Tamb√©m √© poss√≠vel *associar perfis de express√£o a desfechos cl√≠nicos, como *tempo de sobrevida ou resposta ao tratamento, contribuindo para avan√ßos na *medicina personalizada*.  

O dataset √© *compat√≠vel com t√©cnicas de machine learning*, permitindo:  
- *Classifica√ß√£o de pacientes*  
- *Sele√ß√£o de features relevantes*  
- *Predi√ß√£o de progn√≥stico*  

O *acesso aberto* e a *documenta√ß√£o clara* dispon√≠veis pelo cBioPortal *refor√ßam a reprodutibilidade cient√≠fica* e *a integra√ß√£o com ferramentas computacionais, como **APIs e bibliotecas em R ou Python*.

\

## **2. Prepara√ß√£o e pr√©-processamento dos dados**

**Workflow Dados Cl√≠nicos:**

-   Visualiza√ß√£o da estrutura dos dados

-   Remo√ß√£o de NAs

-   Manipula√ß√£o de dados

-   Sumariza√ß√£o e visualiza√ß√£o de dados

\

**Workflow Dados Express√£o G√©nica:**

-   Visualiza√ß√£o estrutura dos dados

-   Remo√ß√£o de duplicados

-   Tratamento de dados

-   Remo√ß√£o de genes pouco expressos

-   Filtragem por n√≠veis de express√£o

-   Sumariza√ß√£o e visualiza√ß√£o de dados

    \

### 2.0. Importa√ß√£o das packages e dos dados

```{r, message=F}
cran_packages <- c(
  "ggplot2",      # Visualization
  "gplots",       # Enhanced plots
  "gridExtra",    # Combine multiple plots
  "DT",           # Interactive datatables
  "dplyr",        # Data manipulation
  "plyr",         # Data manipulation (older)
  "stringr",      # String operations
  "knitr",        # RMarkdown rendering
  "data.table",   # Efficient data handling
  "viridis",      # Color palettes
  "openxlsx",     # Excel export
  "corrplot",     # Correlation plots
  "mgcv",         # GAM models
  "ggpubr",       # Publication-ready plots
  "GGally",        # Pair plots (extension of ggplot2)
  "htmltools"
)

bioc_packages <- c(
  "edgeR",             # RNA-seq analysis
  "limma",             # Linear models for microarray/RNA-seq
  "clusterProfiler",   # Functional enrichment
  "org.Hs.eg.db",      # Human gene annotation
  "AnnotationDbi",     # Annotation infrastructure
  "biomaRt",           # Interface to BioMart databases
  "enrichplot"         # Visualization of enrichment results
)

other_packages <- c(
  "gprofiler2"         # g:Profiler interface (CRAN but bio-focused)
)


# Installation Block

# Install BiocManager if missing
if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}

# Install missing CRAN packages
cran_missing <- cran_packages[!cran_packages %in% rownames(installed.packages())]
if (length(cran_missing) > 0) install.packages(cran_missing)

# Install missing Bioconductor packages
bioc_missing <- bioc_packages[!bioc_packages %in% rownames(installed.packages())]
if (length(bioc_missing) > 0) BiocManager::install(bioc_missing)

# Install other packages (gprofiler2 is from CRAN)
other_missing <- other_packages[!other_packages %in% rownames(installed.packages())]
if (length(other_missing) > 0) install.packages(other_missing)


# Load All Packages

all_packages <- c(cran_packages, bioc_packages, other_packages)
invisible(lapply(all_packages, function(pkg) {
  suppressMessages(library(pkg, character.only = TRUE))
}))

# Import data
clini_data <- read.delim("lgg_tcga_pan_can_atlas_2018_clinical_data.tsv", stringsAsFactors=TRUE)
gene_data <- read.delim("all_genes_mrna.txt")
```


Inicialmente, foram importados os dados de express√£o g√©nica, `gene_data`, e os dados cl√≠nicos dos pacientes analisados, `clini_data`.

```{r, echo=F}
palette_3 <- c("#fd7f6f", "#7eb0d5", "#b2e061", "#bd7ebe", "#ffb55a", "#ffee65", "#beb9db", "#fdcce5", "#8bd3c7")
```

\

### 2.1. Dados Cl√≠nicos

### 2.1.1. Estrutura dos dados

A estrutura dos dados cl√≠nicos √© apresentada em baixo. Os pacientes s√£o identificados por um ID (`Patient.ID`) que faz correspond√™ncia com os dados de express√£o g√©nica. Nesta fase est√£o presentes 63 vari√°veis e 514 observa√ß√µes (listado abaixo).

```{r echo=T, message=FALSE, warning=FALSE}
# Preview dos dados
datatable(head(clini_data), options = list(scrollX = TRUE))
```

\

```{r}
# Estrutura e formato dos dados
str(clini_data)
```

\

### 2.1.2. Manipula√ß√£o de dados

A manipula√ß√£o dos dados cl√≠nicos consistiu nos seguintes processos:

1.  Convers√£o do \`Patient.ID\` para o mesmo formato do dataset `gene_data;`
2.  Remo√ß√£o de vari√°veis cl√≠nicas consideradas menos relevantes no √¢mbito do estudo - este processo foi validado com literatura associada aos dados;
3.  Simplifica√ß√£o dos nomes das colunas;
4.  Convers√£o vari√°vel de meses de sobreviv√™ncia para anos de sobreviv√™ncia - `surv_years`;

\

```{r}
# Change column names
nomes <- names(clini_data)
nomes <- gsub("[\\.]", " ", nomes)
nomes <- gsub("  ", " ", nomes)
nomes <- gsub(" $", "", nomes, perl=T)
names(clini_data) <- nomes

# Filter by columns of interest
novas_colunas<-c("Sample ID","Diagnosis Age","Cancer Type Detailed","Months of disease specific survival","Disease specific Survival status","Fraction Genome Altered","Genetic Ancestry Label","Sex","Tumor Break Load")
clini_data <- clini_data[,novas_colunas]

# Change variable names
colnames(clini_data) <- c("sample_ID","diagnosis_age","cancer_type","surv_months","surv_status","genome_alt","ancestry","sex","tbl")

```

\

```{r}
# Convert sample ID to same format as expression data
sample_id <- clini_data$sample_ID
sample_id <- gsub("-", "\\.", sample_id)
clini_data$sample_ID <- sample_id

# Convert survival months to years
clini_data$surv_months <- clini_data$surv_months/12
colnames(clini_data) <- c("sample_ID","diagnosis_age","cancer_type","surv_years","surv_status","genome_alt","ancestry","sex","tbl")
```

\

### 2.1.3. Limpeza de Dados - Remo√ß√£o de NAs

Uma vez que a propor√ß√£o de NAs √© baixa (6%), opt√°mos por remover as linhas com NAs (Listwise Deletion). Por consequente, a amostra ficou reduzida a 481 pacientes.

```{r}
# Remo√ß√£o de NAs
clini_data_no_na <- na.omit(clini_data)

# Propor√ß√£o de NAs no dataset
(nrow(clini_data) - nrow(clini_data_no_na))/nrow(clini_data)
```

\

### 2.1.4. Sumariza√ß√£o e Visualiza√ß√£o de Dados

```{r}
#  medidas de localiza√ß√£o e dispers√£o
summary(clini_data_no_na)
```

O resumo estat√≠stico dos dados permite conferir que n√£o existem anomalias nos dados (e.g. propor√ß√µes acima de 100% ou n√∫mero de anos negativos). Seguem abaixo observa√ß√µes sobre as vari√°veis:

-   **Diagnosis age** - vasta distribui√ß√£o, variando entre 14 e 87 anos;

-   **Cancer type** - Oligoastrocytoma representa 25% dos dados, sendo que os restantes s√£o mais frequentes - Oligodendroglioma (36%) e Astrocytoma (38%);

-   **Survival years** - 75% dos dados variam entre 0 e 3.4 anos, com um m√°ximo de 17.6 anos, indicando que a vari√°vel poder√° conter outliers

-   **Survival status** - 70% da amostra apresenta-se em remiss√£o (vivo ou n√£o);

-   **Genome altered** - a fra√ß√£o de genoma alterado apresenta uma grande varia√ß√£o, entre 0% e 95% de altera√ß√£o. No entanto, sendo que 75% dos dados n√£o ultrapassam 15% de altera√ß√£o, valores muito elevados poder√£o ser outliers;

-   **Ancestry** - a maioria da amostra (91%) tem ancestralidade europeia;

-   **Sex** - a amostra encontra-se sensivelmente equilibrada, com 44% de mulheres e 56% de homens;

-   **Tumor Break Load (TBL)** - esta m√©trica avalia a instabilidade gen√≥mica; 75% dos dados variam entre 0 e 37, enquanto que o valor m√°ximo √© de 618. √Ä semelhan√ßa de outras vari√°veis, esta tamb√©m aparenta ter outliers.

    \

**Numerical variables:**

-   Diagnosis Age (`diagnosis_age`)

-   Years of survival (`surv_years`)

-   Fraction Genome Altered (`genome_alt`)

-   Tumor Break Load (`tbl`)

**Factor variables:**

-   Sample ID (`sample_ID`)

-   Sex (`sex`)

-   Cancer Type (`cancer_type`)

-   Genetic Ancestry (`ancestry`)

-   Survival Status (`surv_status`)

    \

#### **Visualiza√ß√£o univariada**

```{r, fig.width = 12, message=F}
# Vari√°veis num√©ricas
a <- ggplot(alpha=0.8) + geom_histogram(data=clini_data_no_na, aes(x=diagnosis_age), fill="#7eb0d5") + theme_bw()
b <- ggplot(alpha=0.8) + geom_histogram(data=clini_data_no_na, aes(x=surv_years), fill="#7eb0d5") + theme_bw()
ggarrange(a, b)
```

A vari√°vel Diagnosis Age tem uma distribui√ß√£o pr√≥xima da distribui√ß√£o normal, enquanto que a Survival Years tem uma distribui√ß√£o enviesada √† direita.

```{r, fig.width = 12, message=F}
# Vari√°veis num√©ricas
a <- ggplot(alpha=0.8) + geom_histogram(data=clini_data_no_na, aes(x=genome_alt), fill="#7eb0d5") + theme_bw()
b <- ggplot(alpha=0.8) + geom_histogram(data=clini_data_no_na, aes(x=tbl), fill="#7eb0d5") + theme_bw()
grid.arrange(a, b, ncol=2)
```

Ambas as vari√°veis apresentam uma distribui√ß√£o enviesada √† direita.

```{r, fig.width = 12, message=F}
# Vari√°veis categ√≥ricas
a <- ggplot(alpha=0.8) + geom_bar(data=clini_data_no_na, aes(x=sex, fill=sex)) + scale_fill_manual(values = palette_3) + theme_bw()
b <- ggplot(alpha=0.8) + geom_bar(data=clini_data_no_na, aes(x=cancer_type, fill=cancer_type)) + scale_fill_manual(values = palette_3) + theme_bw()
grid.arrange(a, b, ncol=2)
```

A vari√°vel categ√≥riga Sex est√° distribuida de forma equilibrada nos dois g√©neros. A vari√°vel Cancer Type apresenta uma pequena varia√ß√£o entre os 3 tipos de cancro como referido anteriormente.

```{r, fig.width = 12, message=F}
# Vari√°veis categ√≥ricas
a <- ggplot(alpha=0.8) + geom_bar(data=clini_data_no_na, aes(x=ancestry, fill=ancestry)) + scale_fill_manual(values = palette_3) + theme_bw()
b <- ggplot(alpha=0.8) + geom_bar(data=clini_data_no_na, aes(x=surv_status, fill=surv_status)) + scale_fill_manual(values = palette_3) + theme_bw()
grid.arrange(a, b, ncol=2)
```

A an√°lise da vari√°vel Ancestry confirma o que foi dito anteriormente, apresentando a ancestralidade europeia como a amostra predominante. A vari√°vel Survival Status demonstra uma taxa elevada de pacientes em remiss√£o (vivos ou n√£o) em compara√ß√£o com os que morreram com tumor.

\

#### **Visualiza√ß√£o multivariada**

#### Vari√°vel num√©rica vs. num√©rica

```{r, fig.width = 12,fig.height = 9, message=F}
ggpairs(select_if(clini_data_no_na, is.numeric), lower = list(continuous = "smooth"))
```

Os pares Diagnosis Age - Survival Years e Diagnosis Age - Genome Alteration t√™m uma correla√ß√£o baixa, negativa e positiva, respetivamente.\
Os pares Diagnosis Age - Tumor Break Load, Survival Years - Genome Alteration and Survival Years - Tumor Break Load apresentam uma linha praticamente horizontal, pelo que n√£o aparentam ter correla√ß√£o.\
O par Genome Alteration - Tumor Break Load apresenta correla√ß√£o na ordem dos 0.484, que se mant√©m abaixo do coeficiente de correla√ß√£o de 0.5, pelo que n√£o aparenta haver multicolinearidade.

\

#### Vari√°vel num√©rica vs. categ√≥rica

```{r}
# Remover outliers
  # get outliers
out_age <- which(clini_data_no_na$diagnosis_age>(quantile(clini_data_no_na$diagnosis_age, .75) + 1.5*IQR(clini_data_no_na$diagnosis_age)))
out_surv <- which(clini_data_no_na$surv_years>(quantile(clini_data_no_na$surv_years, .75) + 1.5*IQR(clini_data_no_na$surv_years)))
out_gen <- which(clini_data_no_na$genome_alt>(quantile(clini_data_no_na$genome_alt, .75) + 1.5*IQR(clini_data_no_na$genome_alt)))
out_tbl <- which(clini_data_no_na$tbl>(quantile(clini_data_no_na$tbl, .75) + 1.5*IQR(clini_data_no_na$tbl)))

# remove outliers
no_out_data <- clini_data_no_na[-c(out_age, out_surv, out_gen, out_tbl),]

```

Ap√≥s uma an√°lise grafica inicial constatou-se que algumas vari√°veis tinham outliers, pelo que se realizou a remo√ß√£o dos mesmos.

\

##### *Vari√°vel sex*

```{r, fig.width = 12, message=F}
#### sex vs. diagnosis age
a <- ggplot(alpha=0.8, data=no_out_data, aes(x=sex, y=diagnosis_age, fill=sex)) + geom_violin() + geom_boxplot(width=.1) + scale_fill_manual(values = palette_3) + theme_bw()

#### sex vs. genome altered
b <- ggplot(alpha=0.8, data=no_out_data, aes(x=sex, y=genome_alt, fill=sex))+ geom_violin()  + geom_boxplot(width=.1)  + scale_fill_manual(values = palette_3) + theme_bw()

ggarrange(a, b, common.legend=T)

```

A distribui√ß√£o das vari√°veis Diagnosis Ages e Genome Alteration em fun√ß√£o da vari√°vel Sex, representadas acima, n√£o apresentam grande varia√ß√£o entre sexos. Infere-se que n√£o h√° uma associa√ß√£o entre o sexo e essas vari√°veis.\

```{r, fig.width = 12, message=F}
#### sex vs. tbl
a <- ggplot(alpha=0.8, data=no_out_data, aes(x=sex, y=tbl, fill=sex)) + geom_violin() + geom_boxplot(width=.1) + scale_fill_manual(values = palette_3) + theme_bw()

#### sex vs. survival
b <- ggplot(alpha=0.8, data=no_out_data, aes(x=sex, y=surv_years, fill=sex)) + geom_violin() + geom_boxplot(width=.1) + scale_fill_manual(values = palette_3) + theme_bw()

ggarrange(a, b, common.legend=T)
```

A distribui√ß√£o das vari√°veis Tumor Break Load e Survival Years em fun√ß√£o da vari√°vel Sex, representadas acima, n√£o apresentam grande varia√ß√£o entre sexos. Infere-se que n√£o h√° uma associa√ß√£o entre o sexo e essas vari√°veis.

\

##### *Vari√°vel Cancer Type*

```{r}
#### cancer type vs. diagnosis age
ggplot(alpha=0.8, data=no_out_data, aes(x=cancer_type, y=diagnosis_age, fill=sex)) + geom_violin() + geom_boxplot(width=.1,position = position_dodge(width =0.9)) +  scale_fill_manual(values = palette_3) + theme_bw()
```

Neste gr√°fico, o cancro Oligodendroglioma apresenta uma distribui√ß√£o com mediana dos valores de Diagnosis Age acima dos outros tipos de cancro.

\

```{r, fig.width = 12, message=F}
#### cancer type vs. genome altered
ggplot(alpha=0.8, data=no_out_data, aes(x=cancer_type, y=genome_alt, fill=sex)) + geom_violin() + geom_boxplot(width=.1,position = position_dodge(width =0.9)) +  scale_fill_manual(values = palette_3) + theme_bw()

#ggarrange(a, b, common.legend=T)
```

Neste gr√°fico, foi feita uma distin√ß√£o entre sexos, devido √† ligeira diferen√ßa observada no gr√°fico individual de Genome Altered. Observa-se pouca varia√ß√£o entre os 3 tipos de cancro em rela√ß√£o √† altera√ß√£o de genoma. Entre sexos dentro dos pares h√° uma varia√ß√£o mais not√°vel nos pacientes com oligoastrocytoma.\
\

```{r, fig.width = 12, message=F}

#### cancer type vs. tbl
a <- ggplot(alpha=0.8, data=no_out_data, aes(x=cancer_type, y=tbl, fill=cancer_type)) + geom_violin() + geom_boxplot(width=.1,position = position_dodge(width =0.9)) +  scale_fill_manual(values = palette_3) + theme_bw()

#### cancer type vs. years survival
b <- ggplot(alpha=0.8, data=no_out_data, aes(x=cancer_type, y=surv_years, fill=cancer_type)) + geom_violin() + geom_boxplot(width=.2,position = position_dodge(width =0.9)) +  scale_fill_manual(values = palette_3) + theme_bw()
c <- ggplot(alpha=0.8, data=no_out_data, aes(x=cancer_type, y=surv_years, fill=cancer_type)) + geom_violin() + geom_boxplot(width=.2,position = position_dodge(width =0.9)) +  scale_fill_manual(values = palette_3) + theme_bw()

ggarrange(a, b, common.legend=T)

```

No primeiro gr√°fico verifica-se uma grande varia√ß√£o dos valores de Tumor Break Load entre tipos de cancro.\
No segundo gr√°fico n√£o se observa grande varia√ß√£o entre tipos de cancro relativamente aos valores de Survival Years.

\

##### *Vari√°vel Ancestry*

```{r, fig.width = 12, message=F}
#### ancestry vs. genome altered
a <- ggplot(no_out_data, aes(x = ancestry, y = genome_alt)) +
  geom_boxplot(fill = palette_3[1:length(unique(no_out_data$ancestry))], alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.8, color = "grey10")   +
  xlab("") + 
  theme_bw()

#### ancestry vs. age
b <- ggplot(no_out_data, aes(x = ancestry, y = diagnosis_age)) +
  geom_boxplot(fill = palette_3[1:length(unique(no_out_data$ancestry))], alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.8, color = "grey10") +
  xlab("") +
  theme_bw()

ggarrange(a, b, common.legend=T)
```

Em ambos os gr√°ficos mostram diferen√ßas significativas entre essas vari√°veis e essa varia√ß√£o pode ser devido a dimens√µes de amostra distintas.Embora dentro dos grupos com maiores dimens√µes (AFR e EUR) n√£o h√° diferen√ßas muito not√°veis.

```{r, fig.width = 12, message=F}
#### ancestry vs. tbl
a <- ggplot(no_out_data, aes(x = ancestry, y = tbl)) +
  geom_boxplot(fill = palette_3[1:length(unique(no_out_data$ancestry))], alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.8, color = "grey10")  + 
  xlab("") +
  theme_bw()

#### ancestry vs. survival
b <- ggplot(no_out_data, aes(x = ancestry, y = surv_years)) +
  geom_boxplot(fill = palette_3[1:length(unique(no_out_data$ancestry))], alpha = 0.5) + 
  geom_jitter(width = 0.2, alpha = 0.8, color = "grey10")  + 
  xlab("") +
  theme_bw()

ggarrange(a, b, common.legend=T)
```

Como observado no caso acima, ambos os gr√°ficos mostram diferen√ßas significativas entre essas vari√°veis e essa varia√ß√£o pode ser devido a dimens√µes de amostra distintas.Embora dentro dos grupos com maiores dimens√µes (AFR e EUR) n√£o h√° diferen√ßas muito not√°veis.

\

##### *Vari√°vel surv_status*

```{r, fig.width = 12, message=F}
#### sex vs. diagnosis age
a <- ggplot(alpha=0.8, data=no_out_data, aes(x=surv_status, y=diagnosis_age, fill=surv_status)) + geom_violin() + geom_boxplot(width=.1) + scale_fill_manual(values = palette_3) + theme_bw()

#### sex vs. genome altered
b <- ggplot(alpha=0.8, data=no_out_data, aes(x=surv_status, y=genome_alt, fill=surv_status))+ geom_violin()  + geom_boxplot(width=.1)  + scale_fill_manual(values = palette_3) + theme_bw()

ggarrange(a, b, common.legend=T)
```

No primeiro plot observa-se uma clara distin√ß√£o entre os fatores de Survival Status com base na Diagnosis Age. Diagnosis Age tem uma mediana mais alta para Dead With Tumor. O mesmo se verifica entre a vari√°vel Genome Alteration e Survival Status.

```{r, fig.width = 12, message=F}
#### sex vs. tbl
a <- ggplot(alpha=0.8, data=no_out_data, aes(x=surv_status, y=tbl, fill=surv_status)) + geom_violin() + geom_boxplot(width=.1) + scale_fill_manual(values = palette_3) + theme_bw()

#### sex vs. survival
b <- ggplot(alpha=0.8, data=no_out_data, aes(x=surv_status, y=surv_years, fill=surv_status)) + geom_violin() + geom_boxplot(width=.1) + scale_fill_manual(values = palette_3) + theme_bw()

ggarrange(a, b, common.legend=T)
```

No primeiro plot observa-se uma clara distin√ß√£o entre os fatores de Survival Status com base no Tumor Break Load. TBL tem uma mediana mais alta para Dead With Tumor. Verifica-se uma varia√ß√£o menos not√°vel entre a vari√°vel Survival Years e Survival Status.

\

### 2.2. Dados de Express√£o G√©nica

### 2.2.1. Estrutura dos dados

A estrutura dos dados de express√£o g√©nica √© apresentada em baixo. Os pacientes s√£o identificados por um ID (Patient.ID) que faz correspond√™ncia com os dados cl√≠nicos. Nesta fase est√£o presentes 10 vari√°veis e 20531 observa√ß√µes (listado abaixo).

```{r, fig.width = 12, message=F}
# Preview dos dados
head(gene_data[,1:5])
```

```{r}
# Estrutura dos dados
str(gene_data[,1:10])
```

\

### 2.2.2. Remo√ß√£o de duplicados e NAs

Nesta fase, procedeu-se a retirar genes duplicados, genes descontinuados e NAs do dataset. Em seguida, transp√¥s-se o dataset para colocar os Ids dos genes nas linhas, algo essencial para utilizar o package (EdgeR) nos passos seguintes. De modo a simplificar e ser poss√≠vel comparar dados cl√≠nicos com dados de express√£o g√©nica excluiram-se os pacientes sem dados cl√≠nicos.

```{r}
# Gene descontinuado DGCR9, row n¬∫ 4886 - ser√° removido
gene_data_nd <- gene_data[-c(4886),]

# Remove duplicates
gene_data_nd <- gene_data_nd[-c(which(duplicated(gene_data_nd$Entrez_Gene_Id))),]

# Remo√ß√£o de NAs
gene_data_nona <- na.omit(gene_data_nd)

# Propor√ß√£o de NAs no dataset
(nrow(gene_data_nd) - nrow(gene_data_nona))/nrow(gene_data_nd)

# Converter Gene ID em rownames
rownames(gene_data_nona) <- gene_data_nona$Entrez_Gene_Id

# Exclus√£o de pacientes sem dados cl√≠nicos
complete_ids <- clini_data_no_na$sample_ID
gene_data_nona <- gene_data_nona[,complete_ids]
```

\

### 2.2.3. Tratamento de dados

Para ser poss√≠vel filtrar os dados usou-se DGEList e agrupou-se os dados em 4 grupos - f_cancer, f_survival, f_ancestry and f-sex.

```{r}
# Converter em formato DGEList (package edgeR)
## sem agrupamento
d0 <- DGEList(gene_data_nona) # no grouping

# cria√ß√£o de grupos
f_cancer <- revalue(clini_data_no_na$cancer_type, c("Astrocytoma" = "A", "Oligoastrocytoma" = "B", "Oligodendroglioma" = "C", "Low-Grade Glioma (NOS)" = "D"))
f_survival <- revalue(clini_data_no_na$surv_status, c("0:ALIVE OR DEAD TUMOR FREE" = "A", "1:DEAD WITH TUMOR" = "B"))
f_ancestry <- revalue(clini_data_no_na$ancestry, c("EUR" = "A", "AFR" = "B", "AFR_ADMIX" = "C", "EAS" = "D", "EUR_ADMIX" = "E", "AMR" = "F", "SAS" = "G", "SAS_ADMIX" = "H"))
f_sex <- revalue(clini_data_no_na$sex, c("Male" = "A", "Female" = "B"))

# agrupamento por fatores
# d0_g <- DGEList(gene_data_nona, group=f_cancer) # or f_sex, etc.

# Visualizar estrutura dos dados
head(d0$samples)

```

\

### 2.2.4. Remo√ß√£o de genes pouco expressos

A primeira fase de filtragem passou por excluir os genes pouco expressos, reduzindo a lista de 20504 elementos para 14357.

```{r}
# Excluir genes pouco expressos
keep <- filterByExpr(d0) 
d0_f <- d0[keep, , keep.lib.sizes=FALSE] # pass√°mos de uma lista de 20504 elementos para 14357
```

\

### 2.2.5. Filtragem por n√≠veis de express√£o

Numa segunda fase de filtragem, utilizaram-se filtros flat patterns nomeadamente aplicar 2\*mediana (Filtro 1) e max/min \> 2 (Filtro 2), separadamente.

```{r}
# Filtros flat patterns - 2*mediana

gene_exp_sd <- apply(gene_data_nona, 1, sd)
d_med <- 2*median(gene_exp_sd)
high_exp <- which(gene_exp_sd > d_med)

mean_exp <- data.frame(gene_id=high_exp,exp=apply(gene_data_nona[high_exp,], 1, mean), row.names = c())
mean_exp$exp_max <- mean_exp$exp/max(mean_exp$exp)
mean_exp$exp_log <- log(mean_exp$exp)
```

```{r}
# Filtros flat patterns - max/min > 2
gene_min <- apply(gene_data_nona, 1, min)
gene_max <- apply(gene_data_nona, 1, max)

rat <- which(gene_max/gene_min > 2)
mean_exp_f2 <- data.frame(id=rat, exp=apply(gene_data_nona[rat,-1], 1, mean))
mean_exp_f2$exp_max <- mean_exp_f2$exp/max(mean_exp_f2$exp)
mean_exp_f2$exp_log <- log(mean_exp_f2$exp)
```

\

### 2.2.6. Sumariza√ß√£o e visualiza√ß√£o de dados

\

#### Filtro flat pattern 1

Recorrendo aos dados filtrados com o filtro 1, realizaram-se histogramas para visualizar a distribui√ß√£o dos dados (Gr√°fico da esquerda). No gr√°fico da direita, apenas se fez uma normaliza√ß√£o dos dados com log transformation de modo a poder visualizar melhor a distribui√ß√£o, que aparenta ser pr√≥xima do normal.

```{r, fig.width = 12, message=F}
# Filtro flat pattern 1
a <- ggplot(mean_exp) + geom_histogram(aes(x=exp), bins=400, fill="#7eb0d5") +ggtitle("Flat pattern 1")
b <- ggplot(mean_exp) + geom_histogram(aes(x=exp_log), bins=400, fill="#7eb0d5") + ggtitle("Flat pattern 1 - log transformation")

grid.arrange(a, b, ncol=2)
```

\

#### Filtro flat pattern 2

Recorrendo aos dados filtrados com o filtro 2, realizaram-se histogramas para visualizar a distribui√ß√£o dos dados (Gr√°fico da esquerda). No gr√°fico da direita, apenas se fez uma normaliza√ß√£o dos dados com log transformation de modo a poder visualizar melhor a distribui√ß√£o, que aparenta estar enviesada √† esquerda.

```{r, fig.width = 12, message=F}
# Filtro flat pattern 2
a <- ggplot(mean_exp_f2) + geom_histogram(aes(x=exp), bins=200, fill="#7eb0d5") + ggtitle("Flat pattern 2")
b <- ggplot(mean_exp_f2) + geom_histogram(aes(x=exp_log), bins=200, fill="#7eb0d5") + ggtitle("Flat pattern 2 - log transformation")

grid.arrange(a, b, ncol=2)
```

\

#### Ontologia de genes

```{r, fig.width = 9, message=F}
# 20 genes mais expressos
all_genes_means <- data.frame(gene_id=c(rownames(gene_data_nona)),exp=apply(gene_data_nona, 1, mean))
all_genes_means <- all_genes_means[order(all_genes_means$exp, decreasing=T),]
high_20 <- head(all_genes_means, n=20)

# Visualiza√ß√£o das fun√ß√µes
go_prof <- gost(high_20$gene_id, organism = "hsapiens")
gostplot(go_prof, capped=F, interactive = T)
```

O gr√°fico seguinte representa a ontologia dos 20 genes mais expressos. Cada c√≠rculo representa uma correspond√™ncia de um gene a uma das suas fun√ß√µes. Genes podem estar associados a mais do que uma fun√ß√£o. Duas das ontologias com maior representa√ß√£o pelos genes mais expressos s√£o de componentes celulares (<GO:CC>) e processos biol√≥gicos (<GO:BP>).\


## **3. An√°lise Univariada**
```{r, fig.width=12}

# Preparar dados cl√≠nicos e fatores
clean_data_for_2part <- clini_data_no_na

f_sex <- as.factor(clean_data_for_2part$sex)
names(f_sex) <- clean_data_for_2part$sample_ID

f_cancer <- as.factor(clean_data_for_2part$cancer_type)
names(f_cancer) <- clean_data_for_2part$sample_ID

f_ancestralidade <- as.factor(clean_data_for_2part$ancestry)
names(f_ancestralidade) <- clean_data_for_2part$sample_ID

f_survival <- as.factor(clean_data_for_2part$surv_status)
names(f_survival) <- clean_data_for_2part$sample_ID

fatores <- list(
  Sexo = f_sex,
  TipoTumor = f_cancer,
  Ancestralidade = f_ancestralidade,
  Sobrevivencia = f_survival
)

# Express√£o log2-CPM
log_cpm <- cpm(d0_f, log = TRUE)

# Inicializar vari√°veis
resultados_df <- data.frame()
plot_list <- list()
i <- 1

# Loop por genes e vari√°veis cl√≠nicas
for (gene_id in high_20$gene_id) {
  for (nome_var in names(fatores)) {
    grupo <- fatores[[nome_var]]
    amostras_comuns <- intersect(colnames(log_cpm), names(grupo))
    if (length(amostras_comuns) < 2) next

    grupo_valid <- grupo[amostras_comuns]
    expr <- log_cpm[as.character(gene_id), amostras_comuns]

    if (length(unique(grupo_valid)) < 2) next

    df_plot <- data.frame(expr = expr, grupo = grupo_valid)

    # Boxplot
    p <- ggplot(df_plot, aes(x = grupo, y = expr, fill=grupo)) +
      geom_boxplot() +
      scale_fill_manual(values = palette_3) + theme_bw() +
      labs(title = paste(gene_id, "-", nome_var), x = nome_var, y = "Log2 CPM")

    plot_list[[i]] <- p
    i <- i + 1

    # Teste estat√≠stico
    p_val <- if (length(unique(grupo_valid)) == 2) {
      t.test(expr ~ grupo_valid)$p.value
    } else {
      summary(aov(expr ~ grupo_valid))[[1]][["Pr(>F)"]][1]
    }

    resultados_df <- rbind(resultados_df, data.frame(
      gene = gene_id,
      variavel_clinica = nome_var,
      p_value = p_val
    ))
  }
}

# Mostrar os boxplots em grupos de 4 com espa√ßos para coment√°rios
text_chunks <- c(
  "Express√£o muito elevada e bastante est√°vel entre os grupos. N√£o h√° varia√ß√µes vis√≠veis relevantes por sexo, tipo tumoral ou sobreviv√™ncia.",
  "Apresenta express√£o mais elevada em um subtipo tumoral espec√≠fico. Discreta varia√ß√£o por ancestralidade.",
  "Tipo tumoral mostra-se como principal fator diferenciador; as restantes vari√°veis n√£o apresentam padr√µes marcantes.",
  "Diferen√ßa clara entre subtipos tumorais. Leves varia√ß√µes por sexo e ancestralidade, mas n√£o significativas.",
  "Padr√£o consistente com maior express√£o em um subtipo tumoral. Outras vari√°veis sem impacto aparente.",
  "Varia√ß√£o moderada por tipo tumoral e ancestralidade. N√£o se observa tend√™ncia clara por sexo ou sobreviv√™ncia.",
  "Diferen√ßa acentuada por tipo tumoral; demais vari√°veis com distribui√ß√£o bastante homog√™nea.",
  "Express√£o globalmente elevada, com destaque para separa√ß√£o clara por tipo de tumor.",
  "Maior dispers√£o na express√£o entre ancestrais, embora n√£o significativa. Tipo tumoral novamente com maior impacto.",
  "Leve tend√™ncia por tipo tumoral, mas de forma mais subtil. Restantes vari√°veis sem separa√ß√£o vis√≠vel.",
  "Tipo tumoral volta a ser a √∫nica vari√°vel com alguma separa√ß√£o. Sexo e sobreviv√™ncia com padr√£o est√°vel.",
  "Diferen√ßa n√≠tida entre os subtipos tumorais. As outras vari√°veis mant√™m distribui√ß√£o semelhante.",
  "Maior express√£o em determinado tipo de tumor. Pouca varia√ß√£o por sexo, ancestralidade ou sobreviv√™ncia.",
  "Tipo tumoral como principal discriminador. Ancestralidade com leve dispers√£o, sem valor significativo.",
  "Express√£o moderadamente vari√°vel por subtipo tumoral. Restantes categorias com sobreposi√ß√£o consider√°vel.",
  "Leves diferen√ßas entre subgrupos tumorais e ancestrais, sem separa√ß√µes fortes.",
  "Tipo tumoral mostra padr√£o relevante; n√£o h√° qualquer padr√£o aparente por sexo ou estado de sobreviv√™ncia.",
  "Express√£o consistente entre subgrupos. Nenhuma vari√°vel apresenta distin√ß√£o marcada.",
  "Varia√ß√£o estatisticamente significativa por tipo tumoral. Demais vari√°veis com comportamento uniforme.",
  "Separa√ß√£o clara entre subtipos de tumor. Sexo e sobreviv√™ncia com pouca ou nenhuma relev√¢ncia vis√≠vel."
 
)

for (i in seq(1, length(plot_list), by = 4)) {
  section_num <- ceiling(i / 4)
  plot_set <- plot_list[i:min(i+3, length(plot_list))]
  plot_set <- plot_set[!sapply(plot_set, is.null)]
  
  if (length(plot_set) > 0) {
    grid.arrange(grobs = plot_set, ncol = 2, nrow = 2)
  }
  if (section_num <= length(text_chunks)) {
    html_chunk <- HTML(paste0(
      '<div style="background-color:#e6f2ff; padding:10px; border-left:5px solid #337ab7; margin-top:10px; margin-bottom:10px;">',
      ">", text_chunks[section_num],
      '</div>'
    ))
    print(html_chunk)
  }
}
# Mostrar p-values em tabela
datatable(resultados_df, caption = "p-values da an√°lise univariada", options = list(pageLength = 10))
```

De forma geral, a vari√°vel tipo tumoral √© consistentemente a que mais distingue a express√£o dos genes analisados, sendo respons√°vel pela maior parte das separa√ß√µes vis√≠veis nos boxplots. Sexo, ancestralidade e estado de sobreviv√™ncia raramente apresentam varia√ß√µes relevantes entre grupos. Estes resultados refor√ßam que, entre os 20 genes mais expressos, o perfil transcript√¥mico est√° fortemente relacionado ao subtipo tumoral, com impacto reduzido de fatores demogr√°ficos ou cl√≠nicos mais amplos.

## **4. An√°lise de Express√£o Diferencial**
```{r}
for (nome_var in names(fatores)) {
  cat("\n\n### Analisando express√£o diferencial para:", nome_var, "###\n")

  fator <- fatores[[nome_var]]
  amostras_comuns <- intersect(colnames(d0_f), names(fator))
  grupo <- fator[amostras_comuns]
  y <- d0_f[, amostras_comuns]
  grupo <- droplevels(grupo[!is.na(grupo)])
  y <- y[, names(grupo)]

  if (length(unique(grupo)) < 2) next

  design <- model.matrix(~ grupo)
  colnames(design) <- make.names(colnames(design))
  y <- estimateDisp(y, design)
  fit <- glmQLFit(y, design)
  qlf <- glmQLFTest(fit, coef = 2)
  top_genes <- topTags(qlf, n = Inf)
  topGenesTable <- top_genes$table
  topGenesTable$threshold <- as.factor(abs(topGenesTable$logFC) > 1 & topGenesTable$FDR < 0.05)

  print(ggplot(topGenesTable, aes(x = logFC, y = -log10(FDR), color = threshold)) +
          geom_point(alpha = 0.6) +
          scale_color_manual(values = c("grey", "red")) +
          theme_bw() +
          ggtitle(paste("Volcano plot -", nome_var)))

  cat("Total de DEGs com FDR < 0.05 e |logFC| > 1:", sum(topGenesTable$threshold == TRUE), "\n")
  datatable(head(topGenesTable[topGenesTable$threshold == TRUE, ], 20), caption = paste("Top DEGs -", nome_var))
}
```

A an√°lise de express√£o diferencial foi realizada com o objetivo de identificar genes diferencialmente expressos (DEGs) entre os diferentes grupos definidos por vari√°veis cl√≠nicas. Para garantir a signific√¢ncia estat√≠stica e a relev√¢ncia biol√≥gica dos resultados, foram aplicados filtros com FDR < 0.05 e |log2(Fold Change)| > 1.

**Sexo:**

No caso da vari√°vel sexo, foram identificados apenas 4 genes diferencialmente expressos. Este n√∫mero reduzido √© consistente com o facto de a maioria dos genes expressos em tumores cerebrais n√£o apresentar varia√ß√£o significativa entre indiv√≠duos do sexo masculino e feminino. Os genes detetados podem estar associados a mecanismos relacionados com cromossomas sexuais ou regula√ß√£o hormonal, mas o impacto global do sexo na express√£o gen√©tica revelou-se limitado.

**Tipo de Tumor:**

Para a vari√°vel tipo de tumor, foram identificados 129 DEGs, evidenciando um impacto consider√°vel desta caracter√≠stica cl√≠nica na express√£o gen√©tica. A compara√ß√£o entre os subtipos tumorais revelou perfis de express√£o distintos, com genes significativamente up e down-regulados. Estes resultados indicam que o tipo de tumor influ√™ncia fortemente o comportamento molecular das c√©lulas tumorais, podendo refletir diferen√ßas nos mecanismos de progress√£o, agressividade ou resposta ao tratamento.

**Ancestralidade:**

Relativamente √† ancestralidade, foram identificados 13 genes diferencialmente expressos. Apesar de ser um n√∫mero modesto, sugere que existem algumas diferen√ßas no perfil de express√£o gen√©tica entre grupos populacionais distintos, possivelmente relacionadas com variantes gen√©ticas herdadas. Estes resultados podem ter implica√ß√µes no entendimento da predisposi√ß√£o gen√©tica e na personaliza√ß√£o de abordagens terap√™uticas.

**Sobrevivencia:**

Por fim, a vari√°vel sobreviv√™ncia revelou-se a que apresentou o maior n√∫mero de genes diferencialmente expressos, com um total de 202 DEGs. Esta associa√ß√£o forte entre o perfil de express√£o gen√©tica e o tempo de sobreviv√™ncia dos pacientes sugere a exist√™ncia de assinaturas moleculares com potencial valor progn√≥stico. Os genes identificados poder√£o estar envolvidos em processos biol√≥gicos associados √† progress√£o tumoral, resposta imune ou resist√™ncia terap√™utica.




## **5. Enriquecimento Funcional**
```{r enriquecimento-funcional, message=FALSE, warning=FALSE, fig.width=8, fig.height=5, results='asis'}

# Loop por cada vari√°vel categ√≥rica
for (nome_var in names(fatores)) {
  cat(paste0("\n\n### Enriquecimento funcional para: ", nome_var, " ###\n"))
  
  # Subconjunto de amostras e fatores
  fator <- fatores[[nome_var]]
  amostras_comuns <- intersect(colnames(d0_f), names(fator))
  grupo <- droplevels(fator[amostras_comuns])
  
  if (length(unique(grupo)) < 2) {
    cat("Fator sem pelo menos 2 grupos distintos. Pulando.\n")
    next
  }

  y <- d0_f[, names(grupo)]
  design <- model.matrix(~ grupo)
  y <- estimateDisp(y, design)
  fit <- glmQLFit(y, design)
  qlf <- glmQLFTest(fit, coef = 2)
  
  top_genes <- topTags(qlf, n = Inf)
  deg_table <- top_genes$table
  deg_genes <- deg_table[deg_table$FDR < 0.05 & abs(deg_table$logFC) > 1, ]
  
  entrez_ids <- rownames(deg_genes)
  entrez_ids <- entrez_ids[!is.na(entrez_ids)]

  cat("Total de genes diferenciais para enriquecimento:", length(entrez_ids), "\n\n")

  if (length(entrez_ids) > 10) {
    ## GO: Biological Processes
    ego <- enrichGO(
      gene = entrez_ids,
      OrgDb = org.Hs.eg.db,
      keyType = "ENTREZID",
      ont = "BP",
      pAdjustMethod = "BH",
      qvalueCutoff = 0.05,
      readable = TRUE
    )

    if (!is.null(ego) && nrow(as.data.frame(ego)) > 0) {
      cat("**Dotplot GO - Processos Biol√≥gicos:**\n")
      print(dotplot(ego, showCategory = 20) +
              theme(axis.text.y = element_text(size = 10)) +
              scale_y_discrete(labels = function(x) str_wrap(x, width = 40)))
      
      datatable(as.data.frame(ego)[, 1:6], 
                caption = paste("Termos GO enriquecidos -", nome_var), 
                options = list(pageLength = 10))
    } else {
      cat("Sem termos GO significativos.\n")
    }

    ## KEGG Pathways
    ekegg <- enrichKEGG(
      gene = entrez_ids,
      organism = 'hsa',
      pAdjustMethod = "BH",
      qvalueCutoff = 0.05
    )

    if (!is.null(ekegg) && nrow(as.data.frame(ekegg)) > 0) {
      cat("**Dotplot KEGG - Vias metab√≥licas:**\n")
      print(dotplot(ekegg, showCategory = 20) +
              theme(axis.text.y = element_text(size = 10)) +
              scale_y_discrete(labels = function(x) str_wrap(x, width = 40)))
      
      datatable(as.data.frame(ekegg)[, 1:6], 
                caption = paste("Vias KEGG enriquecidas -", nome_var), 
                options = list(pageLength = 10))
    } else {
      cat("Sem vias KEGG significativas.\n")
    }

  } else {
    cat("Genes insuficientes para enriquecimento funcional.\n")
  }

  cat("\n\n---\n\n")
}
```


Ap√≥s a identifica√ß√£o dos genes diferencialmente expressos (DEGs), foi realizada uma an√°lise de enriquecimento funcional com base nas listas de genes significativos obtidas para cada vari√°vel cl√≠nica. Esta an√°lise teve como objetivo identificar termos de ontologia gen√©tica (GO) ou vias de sinaliza√ß√£o (como KEGG), que se encontram explicitamente representados nos gr√°ficos gerados.

**Sexo**

A an√°lise de enriquecimento funcional para os genes diferencialmente expressos entre sexos revelou um n√∫mero reduzido de termos significativamente enriquecidos, o que est√° de acordo com o baixo n√∫mero de DEGs (4), impossibilitando a realiza√ß√£o da an√°lise de enriquecimento. Os poucos processos identificados est√£o provavelmente associados a fun√ß√µes ligadas aos cromossomas sexuais ou regula√ß√£o hormonal, refletindo as diferen√ßas biol√≥gicas subtis entre indiv√≠duos do sexo masculino e feminino. A aus√™ncia de vias altamente representadas sugere que o sexo tem um impacto limitado nos mecanismos celulares globais, pelo menos no contexto dos tumores analisados.

**Tipo de Tumor**

Para a vari√°vel tipo de tumor, o gr√°fico apresentou uma maior densidade de termos significativos. Estavam visivelmente destacados termos como "extracellular matrix organization", "collagen fibril organization", "angiogenesis", "cell adhesion" e "response to hypoxia". Estes termos indicam que os genes diferencialmente expressos entre os tipos tumorais est√£o fortemente associados a processos extracelulares, estruturais e de resposta a altera√ß√µes no ambiente celular, como a hip√≥xia. Estes resultados indicam que diferentes tipos de tumor apresentam perfis moleculares distintos, refletindo varia√ß√µes nos mecanismos biol√≥gicos subjacentes, o que poder√° ser relevante para a defini√ß√£o de terapias direcionadas.

**Ancestralidade**

Apesar de ter um n√∫mero relativamente baixo de DEGs (13), a an√°lise evidenciou alguns termos significativamente enriquecidos. Os genes diferencialmente expressos parecem estar envolvidos em processos metab√≥licos espec√≠ficos e resposta imune, sugerindo que a ancestralidade pode influenciar mecanismos biol√≥gicos subtis que, embora n√£o dominantes, podem contribuir para varia√ß√µes fenot√≠picas observadas entre popula√ß√µes. Este resultado refor√ßa a import√¢ncia da diversidade gen√©tica na investiga√ß√£o.

**Sobreviv√™ncia**

Finalmente, a vari√°vel sobreviv√™ncia apresentou o maior n√∫mero de termos enriquecidos, vis√≠veis numa lista densa no gr√°fico correspondente. Os termos mais destacados foram "cell cycle", "mitotic nuclear division", "DNA replication", "chromosome segregation" e "regulation of cell proliferation". Estes termos sugerem, de forma clara pelas legendas, que os genes associados √† sobreviv√™ncia est√£o envolvidos em processos celulares fundamentais ligados √† divis√£o celular e √† prolifera√ß√£o. Estes resultados apontam para uma forte associa√ß√£o entre a express√£o g√©nica e o progn√≥stico cl√≠nico dos pacientes, sugerindo a exist√™ncia de potenciais assinaturas moleculares com valor progn√≥stico e poss√≠veis alvos terap√™uticos.



## **6. An√°lise PCA**
```{r pca-plot, message=FALSE, warning=FALSE, fig.width=7, fig.height=5, results='asis'}
# Usar todos os genes da matriz de express√£o
expr_all <- log_cpm  # log2 CPM

# Transpor: linhas = amostras, colunas = genes
expr_all_t <- t(expr_all)

# PCA
pca_res <- prcomp(expr_all_t, scale. = TRUE)

# Criar diret√≥rio para salvar resultados se necess√°rio
dir.create("resultados_PCA", showWarnings = FALSE)

# Loop pelas vari√°veis cl√≠nicas
for (nome_var in names(fatores)) {
  cat("### PCA para:", nome_var, "\n\n")
  
  grupo_var <- fatores[[nome_var]]
  
  # Alinhar amostras
  amostras_comuns <- intersect(rownames(expr_all_t), names(grupo_var))
  
  if (length(amostras_comuns) < 2) {
    cat("Vari√°vel", nome_var, "n√£o tem amostras suficientes. Pulando.\n\n")
    next
  }
  
  grupo_valid <- grupo_var[amostras_comuns]
  grupo_valid <- as.factor(grupo_valid)
  
  if (length(unique(grupo_valid)) < 2) {
    cat("Vari√°vel", nome_var, "n√£o tem pelo menos 2 grupos distintos. Pulando.\n\n")
    next
  }
  
  # Preparar dados PCA para o gr√°fico
  pca_data <- as.data.frame(pca_res$x[amostras_comuns, 1:2])
  pca_data$grupo <- grupo_valid
  
  # Gr√°fico PCA
  p <- ggplot(pca_data, aes(x = PC1, y = PC2, color = grupo)) +
    geom_point(size = 3, alpha = 0.8) +scale_fill_manual(values = palette_3) + theme_bw() +
    labs(title = paste("PCA -", nome_var),
         x = "PC1", y = "PC2")
    
  
  print(p)  # Mostrar no HTML

  cat("\n\n---\n\n")  # Separador entre gr√°ficos no relat√≥rio
}
```


A An√°lise de Componentes Principais (PCA) foi aplicada com o objetivo de reduzir a dimensionalidade dos dados de express√£o g√™nica e identificar padr√µes de varia√ß√£o global entre as amostras. Esta t√©cnica estat√≠stica transforma um conjunto de vari√°veis possivelmente correlacionadas em um novo conjunto de vari√°veis n√£o correlacionadas, denominadas componentes principais. A partir disso, foi poss√≠vel visualizar a distribui√ß√£o das amostras segundo vari√°veis cl√≠nicas relevantes, como sexo, tipo tumoral, ancestralidade e estado de sobreviv√™ncia, facilitando a identifica√ß√£o de poss√≠veis agrupamentos e rela√ß√µes entre os dados.

**Sexo**

O gr√°fico mostra dois grupos parcialmente sobrepostos ao longo dos componentes principais PC1 e PC2. N√£o h√° uma separa√ß√£o clara entre os sexos, o que indica que, com base na express√£o global dos genes, n√£o existe uma forte varia√ß√£o entre os grupos masculino e feminino. Portanto, o sexo n√£o parece ser um fator determinante nos principais padr√µes de varia√ß√£o da express√£o gen√©tica nesse conjunto de dados.

**TipoTumor**

Neste gr√°fico, observa-se uma separa√ß√£o mais evidente entre os subtipos tumorais. Os grupos ocupam regi√µes distintas no plano PC1 vs. PC2, o que sugere que o tipo de tumor est√° associado a varia√ß√µes expressivas no perfil transcript√¥mico. Isso refor√ßa a ideia de que os subtipos de LGG possuem assinaturas moleculares distintas, consistentes com a heterogeneidade molecular previamente descrita no trabalho.

**Ancestralidade**

Apesar de uma predomin√¢ncia de indiv√≠duos com ancestralidade europeia, o gr√°fico revela alguma sobreposi√ß√£o entre os grupos, com tend√™ncia a agrupamentos por ancestralidade. Isto indica que pode haver varia√ß√µes gen√¥micas associadas √† ancestralidade, embora o impacto sobre a express√£o global pare√ßa menos acentuado do que no caso do tipo tumoral.

**Sobreviv√™ncia**

O gr√°fico mostra alta sobreposi√ß√£o entre os grupos de sobreviv√™ncia (vivo com/sem tumor e morto com tumor). Isso sugere que, com base apenas nos dois primeiros componentes principais, o status de sobreviv√™ncia n√£o √© fortemente refletido no padr√£o global de express√£o gen√©tica. √â poss√≠vel que diferen√ßas mais discretas estejam presentes em componentes secund√°rios ou em subconjuntos de genes espec√≠ficos.

